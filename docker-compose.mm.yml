services:
  kalshi_mm_engine:
    env_file:
      - .env
    image: python:3.11-slim
    container_name: kalshi_mm_engine
    restart: unless-stopped
    working_dir: /app
    volumes:
      - ./:/app:rw
      - /home/ubuntu/.kalshi/prod_keys.pem:/run/secrets/prod_keys.pem:ro
      - ./config/markets.txt:/app/config/markets.txt:ro
    environment:
      PYTHONPATH: /app/src
      MM_WS_DISCONNECT_KILL_SECS: "220"   # or 300
      # --- MD SOURCE: WS ---
      PROD_KEYID: ${PROD_KEYID}
      PROD_KEYFILE: /run/secrets/prod_keys.pem
      MM_MD_SOURCE: ws
      # Use same WS as streamer
      WS_URL: ${WS_URL:-wss://api.elections.kalshi.com/trade-api/ws/v2}
      WS_HOSTNAME: ${WS_HOSTNAME:-api.elections.kalshi.com}

      # TEMP DEBUG (turn off once stable)
      MM_WS_DEBUG: ${MM_WS_DEBUG:-0}
      MM_WS_DEBUG_LIMIT: ${MM_WS_DEBUG_LIMIT:-20}

      # --- Markets to quote ---
      # MM_MARKETS is DEPRECATED - use MM_MARKETS_FILE only
      MM_MARKETS_FILE: ${MM_MARKETS_FILE:-/app/config/markets.txt}
      MM_MARKETS_RELOAD_SECS: ${MM_MARKETS_RELOAD_SECS:-5}

      # --- Staleness / loop ---
      MM_POLL_MS: ${MM_POLL_MS:-250}
      MM_MAX_LEVEL_AGE_MS: ${MM_MAX_LEVEL_AGE_MS:-120000}   # tighter for WS
      MM_LOOP_JITTER_MS: ${MM_LOOP_JITTER_MS:-0}
      MM_KILL_ON_STALE: ${MM_KILL_ON_STALE:-0}

      # --- Trading safety defaults (paper-first) ---
      MM_TRADING_ENABLED: ${MM_TRADING_ENABLED:-0}
      MM_SIZE: ${MM_SIZE:-1}
      MM_EDGE_TICKS: ${MM_EDGE_TICKS:-1}
      MM_MAX_POS: ${MM_MAX_POS:-2}
      MM_MAX_LONG_POS: ${MM_MAX_LONG_POS:-2}
      MM_MAX_SHORT_POS: ${MM_MAX_SHORT_POS:-2}
      MM_FLATTEN_TRIGGER_POS: ${MM_FLATTEN_TRIGGER_POS:-2}  # change to e.g. 1 or 2
      MM_MAX_GLOBAL_POS: ${MM_MAX_GLOBAL_POS:-2}
      MM_MAX_REJECTS_PER_MIN: ${MM_MAX_REJECTS_PER_MIN:-10}
      MM_KILL_ON_REJECT_SPIKE: ${MM_KILL_ON_REJECT_SPIKE:-1}
      MM_MIN_REPRICE_TICKS: ${MM_MIN_REPRICE_TICKS:-1}
      MM_QUOTE_REFRESH_MS: ${MM_QUOTE_REFRESH_MS:-1000}

      # --- Inventory skew / flatten-only controls ---
      # Skew quotes based on position to favor flattening.
      MM_SKEW_PER_CONTRACT_TICKS: ${MM_SKEW_PER_CONTRACT_TICKS:-1}
      MM_MAX_SKEW_TICKS: ${MM_MAX_SKEW_TICKS:-5}
      # Above this position (per market), stop adding risk and only quote
      # on the flattening side.
      MM_FLATTEN_TRIGGER_POS: ${MM_FLATTEN_TRIGGER_POS:-2}
      MM_FLATTEN_AGGRESS_TICKS: ${MM_FLATTEN_AGGRESS_TICKS:-5}

      # --- Singleton engine lock (per account+env) ---
      MM_SINGLETON_LOCK: ${MM_SINGLETON_LOCK:-1}
      # Use a stable per-account+env key; default ties to Kalshi key + DB
      MM_LOCK_KEY: ${MM_LOCK_KEY:-mm_engine:${KALSHI_KEY_ID:-no_kid}:${CH_DB:-kalshi}}
      MM_LOCK_TTL_SEC: ${MM_LOCK_TTL_SEC:-30}
      MM_LOCK_REFRESH_SEC: ${MM_LOCK_REFRESH_SEC:-10}

      # --- API creds ---
      KALSHI_KEY_ID: ${KALSHI_KEY_ID}
      KALSHI_PRIVATE_KEY_PATH: /run/secrets/prod_keys.pem
      KALSHI_API_BASE: ${KALSHI_API_BASE:-https://api.elections.kalshi.com/trade-api/v2}

      # --- ClickHouse still used for logs/recon (optional) ---
      CH_URL: ${CH_URL:-http://clickhouse:8123}
      CH_USER: ${CH_USER:-default}
      CH_PWD: ${CH_PWD:-default_password}
      CH_DB: ${CH_DB:-kalshi}
      CLICKHOUSE_LATEST_TABLE: ${CLICKHOUSE_LATEST_TABLE:-latest_levels_v2}

    depends_on:
      - clickhouse

    command: ["/bin/sh","-lc","pip install -r requirements.txt && python -m kalshifolder.mm.main"]
